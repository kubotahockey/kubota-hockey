{% extends 'base.html' %}

{% block title %}Team Overview{% endblock %}

{% block content %}
<div class="row">
    <!-- Team Rankings Sidebar -->
    <div class="col-md-3">
        <div class="card bg-dark text-light mb-4">
            <div class="card-header">
                <h4 class="text-white mb-0">Team Rankings</h4>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for team in teams_ranked %}
                    <li class="list-group-item bg-dark text-light">
                        <a href="{{ url_for('teams_overview', team=team['Team']) }}" class="text-light d-flex align-items-center">
                            <img src="{{ url_for('static', filename='images/logo_teams/' + team['Image']) }}" 
                                 alt="{{ team['Team'] }} Logo" 
                                 class="team-logo-sm mr-2">
                            <div class="d-flex flex-column">
                                <span>{{ team['Rank'] }}. {{ team['Team'] }}</span>
                                <span class="text-muted">{{ team['PTS'] | default(0) | round }} Points</span>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Team Insights Section -->
    <div class="col-md-9">
        <div class="team-insights">
            <div class="team-header d-flex align-items-center mb-3">
                <img src="{{ url_for('static', filename='images/logo_teams/' + team_logo) }}" 
                     alt="{{ team_name }} Logo" 
                     class="team-logo mr-3">
                <h1>{{ team_name }}: 7 Year Outlook</h1>
            </div>

            <!-- Bar Chart for Team Rankings -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <canvas id="teamRankingBarChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="teamProjectionsChart"></canvas>
                </div>
            </div>

            <!-- Leaderboard with FW_DEF Column and Age -->
            <div class="leaderboard mb-3">
                <h3>Player Leaderboard (Sorted by Points)</h3>
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Position</th>
                            <th>Age</th>
                            <th>Games Played</th>
                            <th>Goals</th>
                            <th>Assists</th>
                            <th>Points</th>
                            <th>Penalty Minutes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in leaderboard_data %}
                        <tr>
                            <td><a href="{{ url_for('player_page', player=player['name']) }}">{{ player['name'] }}</a></td>
                            <td>{{ player['fw_def'] }}</td>
                            <td>{{ player['age'] }}</td>
                            <td>{{ player['GP2'] }}</td>
                            <td>{{ player['GTOT'] }}</td>
                            <td>{{ player['ATOT'] }}</td>
                            <td>{{ player['PTSTOT'] }}</td>
                            <td>{{ player['PIM'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rankingCtx = document.getElementById('teamRankingBarChart').getContext('2d');
        const projectionCtx = document.getElementById('teamProjectionsChart').getContext('2d');

        const rankingData = {
            labels: ['Total Team', 'Forwards', 'Defensemen', 'Top 12 FWs', 'Top 6 DEFs', 'FWs U23', 'DEFs U23'],
            datasets: [{
                data: [32 - {{ total_team_rank }},
                       32 - {{ fw_rank }},
                       32 - {{ def_rank }},
                       32 - {{ top_12_fw_rank }},
                       32 - {{ top_6_def_rank }},
                       32 - {{ fw_rank_under_23 }},
                       32 - {{ def_rank_under_23 }}],
                backgroundColor: 'rgba(46, 204, 113, 1)',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 2
            }]
        };

        const rankingOptions = {
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    max: 32,
                    ticks: {
                        color: 'white',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(77, 77, 77, 0.8)'
                    }
                },
                y: {
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(77, 77, 77, 0.8)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return `Rank: ${32 - tooltipItem.raw}`;
                        }
                    }
                }
            }
        };

        new Chart(rankingCtx, {
            type: 'bar',
            data: rankingData,
            options: rankingOptions
        });

        const projectionData = {
            labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7'],
            datasets: [
                {
                    label: '{{ team_name }} Projections',
                    data: {{ pts_projections }},
                    borderColor: 'rgba(46, 204, 113, 1)',
                    backgroundColor: 'rgba(46, 204, 113, 0)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointStyle: 'circle',
                    pointRadius: 6,
                    showLine: true
                },
                {
                    label: 'Top Team Projections',
                    data: {{ top_team_projections }},
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Lowest Team Projections',
                    data: {{ lowest_team_projections }},
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'League Average Projections',
                    data: {{ league_average_projections }},
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                }
            ]
        };

        const projectionOptions = {
            scales: {
                y: {
                    beginAtZero: false,
                    max: 2,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(77, 77, 77, 0.8)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    },
                    grid: {
                        color: 'rgba(77, 77, 77, 0.8)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'white',
                        usePointStyle: true
                    }
                },
                title: {
                    display: true,
                    text: '7 Year Point per Game Projection - Top 3 Comparables',
                    color: 'white',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(tooltipItem) {
                            return `${tooltipItem.dataset.label}: ${tooltipItem.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false
        };

        new Chart(projectionCtx, {
            type: 'line',
            data: projectionData,
            options: projectionOptions
        });
    });
</script>
{% endblock %}

